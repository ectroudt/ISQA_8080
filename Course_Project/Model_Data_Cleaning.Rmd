---
title: "ISQA8080_Course_Project_Data_Cleaning"
author: "Eric Troudt"
date: "October 13, 2019"
output: html_document
---


## R Markdown

```{r Libraries and WD}

# --- install and load all libraries needed for the different classification models ---

## ** the glmnet package requires R 3.6.1, make sure it is installed

load.lib<-c("Hmisc", "e1071", "caret","GGally","lubridate","RANN",
"tidyverse", "pROC", "doParallel", "rpart", "rpart.plot", 
"randomForest", "xgboost", "kernlab", "glmnet", "DMwR")

install.lib<-load.lib[!load.lib %in% installed.packages()]

for(lib in install.lib) install.packages(lib,dependencies=TRUE)

sapply(load.lib,require,character=TRUE)

# set wd
tryCatch({
  setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
  }, error=function(cond){message(paste("cannot change working directory"))
})

# set knitr options
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

# configure doParallel
num_cores <- detectCores() #note: you can specify a smaller number if you want
cl <- makePSOCKcluster(num_cores)
registerDoParallel(cl)


```



```{r Model variable processing}

model_data <- read.csv("Model Dataset for Students.csv")


firm_Data <- read.csv("Firmographic Data for Students.csv")

model_data$churned <- as.factor(model_data$churned)

model_data <- model_data %>% mutate(churned, churned = recode(churned, '0' = 'No', '1' = 'Yes'))

model_data[["churned"]] <-relevel(model_data[["churned"]], "Yes")

model_data$Company_Creation_Date <- as.character(model_data$Company_Creation_Date)

model_data$Company_Creation_Date <- dmy_hms(model_data$Company_Creation_Date)

merge_Data <- merge(model_data, firm_Data, by.x = 'Company_Number', by.y = 'Company_Number')

model_Variables <- c("Business_Code", "Location_Type", "churned", "total_products", "total_transactions", "total_accounts", "total_revenue", "total_usage", "Employee_Count_Total", "Company_Number", "Public_Private_Indicator", "Small_Business_Indicator", "Minority_Owned_Indicator", "Major_Industry_Category_Name", "Legal_Status_Code", "Import_Export_Agent_Code", "Population_Code", "Number_of_Family_Members", "Status_Code", "Subsidiary_Indicator", "Manufacturing_Indicator")

merge_Data_subset <- subset(merge_Data, select = model_Variables)

merge_Data_subset <- merge_Data_subset %>% mutate_all(na_if, "")


merge_Data_subset <- merge_Data_subset %>% 
  mutate(Legal_Status_Code = case_when(
    Legal_Status_Code == 3 ~ "corporation",
    Legal_Status_Code == 8 ~ "joint venture",
    Legal_Status_Code == 12 ~ "partnership of unknown type",
    Legal_Status_Code == 13 ~ "proprietorship",
    Legal_Status_Code == 50 ~ "government body",
    Legal_Status_Code == 100 ~ "cooperative",
    Legal_Status_Code == 101 ~ "non profit organization",
    Legal_Status_Code == 118 ~ "local government body",
    Legal_Status_Code == 120 ~ "foreign company",
    TRUE ~ "Other"
  )
)

merge_Data_subset <- merge_Data_subset %>% 
  mutate(Import_Export_Agent_Code = case_when(
    Import_Export_Agent_Code == "A" ~ "Import/Export/Agent",
    Import_Export_Agent_Code == "B" ~ "Imports & Exports",
    Import_Export_Agent_Code == "C" ~ "Imports",
    Import_Export_Agent_Code == "D" ~ "Imports & Agent",
    Import_Export_Agent_Code == "E" ~ "Exports & Agent",
    Import_Export_Agent_Code == "F" ~ "Agent - keeps no inventory and does not take title goods",
    Import_Export_Agent_Code == "G" ~ " None or Not Available",
    Import_Export_Agent_Code == "H" ~ "Exports",
    TRUE ~ "None or Not Available"
  )
)

merge_Data_subset <- merge_Data_subset %>% 
  mutate(Status_Code = case_when(
    Status_Code == 0 ~ "Single Location",
    Status_Code == 1 ~ "Headquarter/Parent",
    Status_Code == 2 ~ "Branch"
  )
)

merge_Data_subset <- merge_Data_subset %>% 
  mutate(Population_Code = case_when(
    Population_Code == 0 ~ "Under 1,000",
    Population_Code == 1 ~ "1,000 to 2,499",
    Population_Code == 2 ~ "2,500 to 4,999",
    Population_Code == 3 ~ "5,000 to 9,999",
    Population_Code == 4 ~ "10,000 to 24,999",
    Population_Code == 5 ~ "25,000 to 49,999",
    Population_Code == 6 ~ "50,000 to 99,999",
    Population_Code == 7 ~ "100,000 to 249,999",
    Population_Code == 8 ~ "250,000 to 499,999",
    Population_Code == 9 ~ "500,000 and over"
  )
)


merge_Data_subset <- merge_Data_subset %>% 
  mutate(Subsidiary_Indicator = case_when(
    Subsidiary_Indicator == 0 ~ "N",
    Subsidiary_Indicator == 3 ~ "Y"
  )
)

merge_Data_subset <- merge_Data_subset %>% 
  mutate(Manufacturing_Indicator = case_when(
    Manufacturing_Indicator == 0 ~ "Y",
    Manufacturing_Indicator == 1 ~ "N"
  )
)


```

```{r Model dataset imput missing values}


merge_Data_subset_NUM <- merge_Data_subset %>% select_if(is.numeric)

merge_Data_subset_nonNUM <- merge_Data_subset %>% select_if(~!is.numeric(.x))

for(Var in colnames(merge_Data_subset_nonNUM)) {
  
  merge_Data_subset_nonNUM[[Var]] <- addNA(merge_Data_subset_nonNUM[[Var]], ifany = TRUE)
  merge_Data_subset_nonNUM[[Var]] <- droplevels(merge_Data_subset_nonNUM[[Var]])
  
}

(high_Correlation <- findCorrelation(cor(merge_Data_subset_NUM)))


# Use preProcess to imput missing values using KNN model, **May automatically apply centering and scaling?
pre_Imputed_model_Data <- preProcess(merge_Data_subset_NUM, method = c("bagImpute", "scale", "center"))
imputed_model_Data <- predict(pre_Imputed_model_Data, merge_Data_subset_NUM)


model_data_bagImputed<- cbind(merge_Data_subset_nonNUM, imputed_model_Data)

chrned_Data <- subset(merge_Data, merge_Data[,"churned"] == "Yes")


summary(model_data_bagImputed)

ggpairs(model_data_bagImputed)

ggpairs(model_data_bagImputed, columns = c(3, 1), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 2), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 4), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 5), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 6), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 7), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 8), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 9), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 10), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 11), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 12), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 13), aes(color = churned))
ggpairs(model_data_bagImputed, columns = c(3, 14), aes(color = churned))


write.csv(model_data_bagImputed, file = "model_data_bagImputed.csv")

```

```{r stop cluster}

# we should close / stop the parallel clusters once we're done
stopImplicitCluster()

```
